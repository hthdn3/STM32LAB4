/*
 * uart_communiation_fsm.c
 *
 *  Created on: Nov 19, 2023
 *      Author: Acer
 */

#include "uart_communiation_fsm.h"
#include "gloabal.h"
#include "software_timer.h"
uint32_t ADC_value = 0;
char str[50];
void is_reset(){
	if(command_length == 3 && command_data[0] == 0x52 && command_data[1] == 0x53 && command_data[2] == 0x54){
		return 1;
	}
	return 0;
}
void is_ok(){
	if(command_length == 2 && command_data[0] == 0x4F && command_data[1] == 0x4B){
		return 1;
	}
	return 0;
}
void uart_communiation_fsm(){
	switch (status_communication){
	case NON:
		if(command_flag == 1){
			command_flag = 0;
			if((is_reset)){
				status_communication = adc_transmit;
				setTimer1(10);
				ADC_value = HAL_ADC_GetValue(&hadc1);
			}
		}
		break;
	}
	case adc_transmit :
		if(timer1_flag == 1){
			setTimer1(300);
			HAL_UART_Transmit(&huart2, (void *) str, sprintf(str, "!ADC=%.4d#", ADC_value), 1000);
			HAL_GPIO_TogglePin(LED_RED_GPIO_Port, LED_RED_Pin);
		}
		if(command_flag ==1){
			command_flag = 0;
		if(is_ok){
			status_communication = NON;
		   }
		}
		break;
	default:
		break;
}



